<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>iPDFall — PDF Toolkit (Desktop + Mobile)</title>
<meta name="description" content="iPDFall: Merge, split, compress, convert, reorder, watermark — all client‑side.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg: #0b0b12;
  --fg: #ffffff;
  --muted: rgba(255,255,255,.82);
  --glass: rgba(255,255,255,.08);
  --stroke: rgba(255,255,255,.18);
  --heart-size: 128px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;overflow-x:hidden}
a{color:#fff}
/* 3D background */
#bg3d{position:fixed;inset:0;z-index:-2}
.gradient{position:fixed;inset:0;z-index:-1;background:
  radial-gradient(800px 500px at 10% 15%, rgba(255,180,255,.18), transparent),
  radial-gradient(900px 600px at 90% 10%, rgba(150,210,255,.18), transparent),
  radial-gradient(900px 600px at 50% 90%, rgba(120,240,180,.18), transparent);
  backdrop-filter: blur(14px);
}

/* Header + burger */
header{position:sticky;top:0;z-index:10;background:linear-gradient(to bottom, rgba(11,11,18,.9), rgba(11,11,18,.4) 60%, transparent);backdrop-filter: blur(8px)}
.container{max-width:1200px;margin:0 auto;padding:10px 18px}
.brand{display:flex;align-items:center;gap:10px;user-select:none}
.brand h1{margin:0;font-weight:800;letter-spacing:-.02em}
nav.desktop{display:flex;gap:16px;font-weight:600}
.burger{display:none;border:1px solid var(--stroke);background:var(--glass);border-radius:12px;padding:8px 10px}
@media(max-width:880px){ nav.desktop{display:none} .burger{display:inline-flex} }

/* Drawer menu */
#drawer{position:fixed;inset:0;display:none}
#drawer.active{display:block}
.drawer-bg{position:absolute;inset:0;background:rgba(0,0,0,.55)}
.drawer-panel{position:absolute;right:0;top:0;bottom:0;width:min(420px,100%);background:#11131a;border-left:1px solid var(--stroke);padding:18px;overflow:auto}
.drawer-panel h3{margin:0 0 8px}

/* Hearts */
.heart-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:18px}
.heart{width:var(--heart-size);height:calc(var(--heart-size) - 8px);position:relative;margin:0 auto;transform:rotate(-45deg);border-radius:16px;cursor:pointer;transition:transform .15s ease,filter .2s ease;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.heart::before,.heart::after{content:"";position:absolute;width:var(--heart-size);height:var(--heart-size);border-radius:50%}
.heart::before{top:calc(var(--heart-size) * -0.5);left:0}
.heart::after{left:calc(var(--heart-size) * 0.5);top:0}
.heart .content{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:10px;text-align:center;transform:rotate(45deg)}
.heart .content span{font-weight:800;font-size:13px;line-height:1.15;text-shadow:0 2px 10px rgba(0,0,0,.4)}
.heart:hover{transform:rotate(-45deg) translateY(-2px) scale(1.03);filter:brightness(1.05)}

.merge{background:#ff6b6b}.merge::before,.merge::after{background:#ff6b6b}
.split{background:#7c4dff}.split::before,.split::after{background:#7c4dff}
.compress{background:#20c997}.compress::before,.compress::after{background:#20c997}
.img2pdf{background:#f6aa1c}.img2pdf::before,.img2pdf::after{background:#f6aa1c}
.pdf2img{background:#3ec5ff}.pdf2img::before,.pdf2img::after{background:#3ec5ff}
.reorder{background:#ff8fab}.reorder::before,.reorder::after{background:#ff8fab}
.watermark{background:#5dd3b3}.watermark::before,.watermark::after{background:#5dd3b3}

section{padding:22px 0}
h2{margin:0 0 6px;font-size:34px}
p.lead{color:var(--muted);margin:6px 0 0}
.panel{background:var(--glass);border:1px solid var(--stroke);border-radius:18px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
.row{display:grid;grid-template-columns:1fr;gap:12px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(min-width:900px){ .row{grid-template-columns:1fr 1fr} }
input[type=file],input[type=text],input[type=number],select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff}
.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);padding:.7rem 1.1rem;border-radius:12px;font-weight:800;color:#fff;cursor:pointer}
.btn[disabled]{opacity:.55;cursor:not-allowed}
.drop{border:1.5px dashed rgba(255,255,255,.45);border-radius:12px;padding:12px}
footer{padding:28px 0 40px;color:var(--muted)}
/* Mobile tweaks */
@media(max-width:480px){
  :root{ --heart-size: 108px }
  h2{font-size:28px}
  .heart .content span{font-size:12px}
}
</style>
</head>
<body>
  <canvas id="bg3d"></canvas>
  <div class="gradient"></div>

  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div class="brand">
        <div style="width:40px;height:40px;border-radius:12px;background:var(--glass);border:1px solid var(--stroke);display:grid;place-items:center">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16"/><path d="M4 12h16"/><path d="M4 17h10"/></svg>
        </div>
        <h1>iPDFall</h1>
      </div>
      <nav class="desktop">
        <a href="#features">Features</a>
        <a href="#tools">Tools</a>
        <a href="#contact">Contact</a>
        <a href="#privacy">Privacy</a>
      </nav>
      <button class="burger" id="openDrawer" aria-label="Open menu">☰</button>
    </div>
  </header>

  <!-- Drawer -->
  <div id="drawer" aria-hidden="true">
    <div class="drawer-bg" id="closeDrawer"></div>
    <aside class="drawer-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>Tools</h3>
        <button class="btn" id="closeDrawerBtn">Close</button>
      </div>
      <div class="heart-grid" id="drawerHearts"></div>
    </aside>
  </div>

  <!-- Hero / Hearts -->
  <section class="container" id="features" style="padding:26px 0 10px">
    <h2>All your PDF tools in a heart‑beat.</h2>
    <p class="lead">Tap a heart to jump to a tool. 100% private, runs in your browser.</p>
    <div class="heart-grid" id="heartGrid" style="margin-top:16px"></div>
  </section>

  <!-- Tools -->
  <section class="container" id="tools">
    <div class="row">
      <div id="merge" class="panel">
        <h3>Merge PDFs</h3>
        <p class="lead">Combine multiple PDFs into one file.</p>
        <div class="drop"><input type="file" id="mergeFiles" accept="application/pdf" multiple></div>
        <button class="btn" id="btnMerge">Merge & Download</button>
      </div>

      <div id="split" class="panel">
        <h3>Split PDF</h3>
        <p class="lead">Enter pages/ranges like <code>1,3,5-8</code>. Each range saved as a file inside a ZIP.</p>
        <div class="drop">
          <input type="file" id="splitFile" accept="application/pdf">
          <input type="text" id="splitRanges" placeholder="e.g., 1,3,5-8">
        </div>
        <button class="btn" id="btnSplit">Split & Download ZIP</button>
      </div>

      <div id="compress" class="panel">
        <h3>Compress PDF</h3>
        <p class="lead">Rasterizes pages at chosen quality for smaller size. (Text becomes non-selectable)</p>
        <div class="drop">
          <input type="file" id="compressFile" accept="application/pdf">
          <label>Quality
            <select id="compressQuality">
              <option value="0.9">High (best)</option>
              <option value="0.7" selected>Balanced</option>
              <option value="0.5">Small (more compression)</option>
              <option value="0.35">Tiny (max compression)</option>
            </select>
          </label>
        </div>
        <button class="btn" id="btnCompress">Compress & Download</button>
      </div>

      <div id="img2pdf" class="panel">
        <h3>Images → PDF</h3>
        <p class="lead">Add JPG/PNG → one multi‑page PDF. Pages sized to image by default.</p>
        <div class="drop">
          <input type="file" id="img2pdfFiles" accept="image/*" multiple>
          <label style="display:block;margin-top:8px">Page Size
            <select id="img2pdfSize">
              <option value="Fit">Fit to image (default)</option>
              <option value="A4">A4</option>
              <option value="Letter">Letter</option>
            </select>
          </label>
        </div>
        <button class="btn" id="btnImg2Pdf">Create PDF</button>
      </div>

      <div id="pdf2img" class="panel">
        <h3>PDF → Images</h3>
        <p class="lead">Export each page to PNG/JPG then download a ZIP.</p>
        <div class="drop">
          <input type="file" id="pdf2imgFile" accept="application/pdf">
          <div class="row2">
            <label>Format
              <select id="pdf2imgFmt"><option>PNG</option><option>JPG</option></select>
            </label>
            <label>Scale (1–3)
              <input type="number" id="pdf2imgScale" min="1" max="3" step="0.25" value="2">
            </label>
          </div>
        </div>
        <button class="btn" id="btnPdf2Img">Export ZIP</button>
      </div>

      <div id="reorder" class="panel" style="grid-column:1/-1">
        <h3>Reorder, Rotate & Delete (Simple)</h3>
        <p class="lead">For mobile reliability, use field below to set new order and rotations. Example: <code>1R,3L,2,4X</code> (R=rotate 90°, L=-90°, X=delete).</p>
        <div class="drop">
          <input type="file" id="reorderFile" accept="application/pdf">
          <input type="text" id="orderSpec" placeholder="e.g., 1,2R,3L,4X (1-based indices)">
        </div>
        <button class="btn" id="btnExportOrder">Export New PDF</button>
      </div>

      <div id="watermark" class="panel" style="grid-column:1/-1">
        <h3>Add Text Watermark</h3>
        <p class="lead">Overlay semi‑transparent text on every page.</p>
        <div class="drop">
          <input type="file" id="wmFile" accept="application/pdf">
          <div class="row2" style="margin-top:8px">
            <label>Text <input type="text" id="wmText" placeholder="WATERMARK"></label>
            <label>Opacity (0.1–1) <input type="number" id="wmOpacity" min="0.1" max="1" step="0.1" value="0.25"></label>
            <label>Angle (deg) <input type="number" id="wmAngle" value="-30"></label>
          </div>
        </div>
        <button class="btn" id="btnWatermark">Apply & Download</button>
      </div>
    </div>
  </section>

  <section id="privacy" class="container">
    <div class="panel"><strong>Privacy:</strong> all operations are client‑side. Close the tab and everything vanishes. After first load, you can even use it offline.</div>
  </section>

  <section id="contact" class="container">
    <div class="panel" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <h3>Contact us</h3>
        <p>Mobile: <a href="tel:+971561581606">+971 56 158 1606</a></p>
        <p>Email: <a href="mailto:iqusmart12@gmail.com">iqusmart12@gmail.com</a></p>
      </div>
      <form onsubmit="event.preventDefault(); alert('Thanks! This demo form does not send data to a server.');" style="display:grid;gap:8px">
        <input required placeholder="Your name">
        <input type="email" required placeholder="Your email">
        <textarea rows="4" required placeholder="Message"></textarea>
        <button class="btn">Send</button>
      </form>
    </div>
  </section>

  <footer class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <p>© <span id="year"></span> iPDFall — Not affiliated with iLovePDF.</p>
      <a href="#features">Back to top ↑</a>
    </div>
  </footer>

  <!-- CDNs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js';</script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
  // ===== 3D BG =====
  (function(){
    const canvas=document.getElementById('bg3d');
    const renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
    const scene=new THREE.Scene();
    const camera=new THREE.PerspectiveCamera(60, innerWidth/innerHeight, .1, 100);
    const light1=new THREE.PointLight(0xffffff,.9); light1.position.set(5,5,5); scene.add(light1);
    const light2=new THREE.PointLight(0x88ccff,.6); light2.position.set(-4,-2,3); scene.add(light2);
    const geo=new THREE.TorusKnotGeometry(1.4,.36,200,16);
    const mat=new THREE.MeshStandardMaterial({color:0xffffff,metalness:.3,roughness:.25});
    const mesh=new THREE.Mesh(geo,mat); scene.add(mesh);
    camera.position.set(0,0,4.2);
    function resize(){ renderer.setSize(innerWidth,innerHeight,false); camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); }
    addEventListener('resize', resize); resize();
    function anim(){ mesh.rotation.x+=0.003; mesh.rotation.y+=0.002; renderer.render(scene,camera); requestAnimationFrame(anim); } anim();
  })();

  // ===== Utils =====
  const $=sel=>document.querySelector(sel);
  const byName=f=> (f?.name||'file').replace(/\s+/g,'_').replace(/\.[^.]+$/,'');
  const downloadBytes=(filename, bytes)=>{
    const blob = (bytes instanceof Blob)? bytes : new Blob([bytes]);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1500);
  };
  const readBuf=f=> new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsArrayBuffer(f); });

  // Hearts
  const hearts=[
    {id:'merge', label:'Merge PDFs', cls:'merge'},
    {id:'split', label:'Split PDF', cls:'split'},
    {id:'compress', label:'Compress', cls:'compress'},
    {id:'img2pdf', label:'Images → PDF', cls:'img2pdf'},
    {id:'pdf2img', label:'PDF → Images', cls:'pdf2img'},
    {id:'reorder', label:'Reorder / Rotate', cls:'reorder'},
    {id:'watermark', label:'Watermark', cls:'watermark'},
  ];
  function renderHearts(targetId){
    const el=$(targetId);
    el.innerHTML='';
    hearts.forEach(h=>{
      const a=document.createElement('a'); a.href='#'+h.id; a.className='heart '+h.cls; a.setAttribute('role','button');
      a.innerHTML='<div class="content"><span>'+h.label+'</span></div>'; el.appendChild(a);
    });
  }
  renderHearts('#heartGrid');
  renderHearts('#drawerHearts');

  // Drawer behavior
  const drawer = $('#drawer'), openBtn = $('#openDrawer'), closeBg = $('#closeDrawer'), closeBtn = $('#closeDrawerBtn');
  const closeDrawer=()=>{drawer.classList.remove('active');drawer.setAttribute('aria-hidden','true');};
  const openDrawer=()=>{drawer.classList.add('active');drawer.setAttribute('aria-hidden','false');};
  openBtn.addEventListener('click', openDrawer);
  closeBg.addEventListener('click', closeDrawer);
  closeBtn.addEventListener('click', closeDrawer);

  // Year
  document.getElementById('year').textContent=new Date().getFullYear();

  // ===== Merge =====
  document.getElementById('btnMerge').addEventListener('click', async ()=>{
    const files=[...document.getElementById('mergeFiles').files]; if(!files.length) return alert('Add PDFs to merge');
    try{
      const {PDFDocument}=PDFLib; const out=await PDFDocument.create();
      for(const f of files){ const src=await PDFDocument.load(await readBuf(f)); const copied=await out.copyPages(src, src.getPageIndices()); copied.forEach(p=>out.addPage(p)); }
      const bytes=await out.save(); downloadBytes('iPDFall-merge.pdf', bytes);
    }catch(e){ console.error(e); alert('Merge failed: '+e.message); }
  });

  // ===== Split =====
  function parseRanges(str,total){
    const set=new Set();
    (str||'').split(',').map(s=>s.trim()).filter(Boolean).forEach(part=>{
      if(/^\d+$/.test(part)){ const n=+part; if(n>=1&&n<=total) set.add(n-1); }
      else if(/^\d+-\d+$/.test(part)){ let [a,b]=part.split('-').map(n=>+n); if(a>b) [a,b]=[b,a]; for(let i=Math.max(1,a); i<=Math.min(total,b); i++) set.add(i-1); }
    });
    return [...set].sort((a,b)=>a-b);
  }
  document.getElementById('btnSplit').addEventListener('click', async ()=>{
    const f=document.getElementById('splitFile').files[0]; if(!f) return alert('Choose a PDF');
    const rangesStr=document.getElementById('splitRanges').value.trim();
    try{
      const {PDFDocument}=PDFLib; const src=await PDFDocument.load(await readBuf(f));
      const idx = rangesStr? parseRanges(rangesStr, src.getPageCount()) : src.getPageIndices();
      const zip=new JSZip();
      for(const i of idx){
        const out=await PDFDocument.create();
        const [page]=await out.copyPages(src,[i]); out.addPage(page);
        const bytes=await out.save(); zip.file(`${byName(f)}-p${i+1}.pdf`, bytes);
      }
      const blob=await zip.generateAsync({type:'blob'}); downloadBytes(`${byName(f)}-split.zip`, blob);
    }catch(e){ console.error(e); alert('Split failed: '+e.message); }
  });

  // ===== Compress (rasterize) =====
  async function renderPdfToCanvasArray(buf, scale){
    const task=pdfjsLib.getDocument({data:buf}); const pdf=await task.promise; const canv=[];
    for(let p=1;p<=pdf.numPages;p++){
      const page=await pdf.getPage(p); const viewport=page.getViewport({scale});
      const cv=document.createElement('canvas'); const ctx=cv.getContext('2d');
      cv.width=Math.ceil(viewport.width); cv.height=Math.ceil(viewport.height);
      await page.render({canvasContext:ctx, viewport}).promise; canv.push(cv);
    }
    return canv;
  }
  document.getElementById('btnCompress').addEventListener('click', async ()=>{
    const f=document.getElementById('compressFile').files[0]; if(!f) return alert('Choose a PDF');
    const q=parseFloat(document.getElementById('compressQuality').value)||0.7;
    try{
      const {PDFDocument}=PDFLib; const canv=await renderPdfToCanvasArray(await readBuf(f), 1.35);
      const out=await PDFDocument.create();
      for(const cv of canv){
        const url=cv.toDataURL('image/jpeg', q);
        const jpg=await (await fetch(url)).arrayBuffer();
        const img=await out.embedJpg(jpg);
        const page=out.addPage([img.width,img.height]);
        page.drawImage(img,{x:0,y:0,width:img.width,height:img.height});
      }
      const bytes=await out.save({useObjectStreams:true}); downloadBytes(`${byName(f)}-compressed.pdf`, bytes);
    }catch(e){ console.error(e); alert('Compress failed: '+e.message); }
  });

  // ===== Images → PDF =====
  function pageSize(name){
    const mm=(w,h)=>[w/25.4*72, h/25.4*72];
    switch(name){ case 'A4': return mm(210,297); case 'Letter': return [612,792]; default: return null; }
  }
  document.getElementById('btnImg2Pdf').addEventListener('click', async ()=>{
    const files=[...document.getElementById('img2pdfFiles').files].sort((a,b)=>a.name.localeCompare(b.name));
    if(!files.length) return alert('Select images');
    try{
      const {PDFDocument}=PDFLib; const out=await PDFDocument.create(); const size=pageSize(document.getElementById('img2pdfSize').value);
      for(const f of files){
        const buf=await readBuf(f);
        const isPng = /png/i.test(f.type) || f.name.toLowerCase().endsWith('.png');
        const img = isPng ? await out.embedPng(buf) : await out.embedJpg(buf);
        const [pw,ph] = size || [img.width, img.height];
        const page = out.addPage([pw,ph]);
        const scale = Math.min(pw/img.width, ph/img.height);
        const dw = img.width*scale, dh = img.height*scale;
        page.drawImage(img,{x:(pw-dw)/2, y:(ph-dh)/2, width:dw, height:dh});
      }
      const bytes=await out.save(); downloadBytes('images-to-pdf.pdf', bytes);
    }catch(e){ console.error(e); alert('Images→PDF failed: '+e.message); }
  });

  // ===== PDF → Images =====
  document.getElementById('btnPdf2Img').addEventListener('click', async ()=>{
    const f=document.getElementById('pdf2imgFile').files[0]; if(!f) return alert('Choose a PDF');
    const fmt=document.getElementById('pdf2imgFmt').value; const scale=Math.max(1, Math.min(3, parseFloat(document.getElementById('pdf2imgScale').value)||2));
    try{
      const buf=await readBuf(f); const task=pdfjsLib.getDocument({data:buf}); const pdf=await task.promise; const zip=new JSZip();
      for(let p=1;p<=pdf.numPages;p++){
        const page=await pdf.getPage(p); const v=page.getViewport({scale});
        const cv=document.createElement('canvas'); const ctx=cv.getContext('2d');
        cv.width=Math.ceil(v.width); cv.height=Math.ceil(v.height);
        await page.render({canvasContext:ctx, viewport:v}).promise;
        const blob = await new Promise(r=> cv.toBlob(r, fmt==='JPG'?'image/jpeg':'image/png', .92));
        zip.file(`page-${String(p).padStart(3,'0')}.${fmt.toLowerCase()}`, blob);
      }
      const zipBlob=await zip.generateAsync({type:'blob'}); downloadBytes(`${byName(f)}-pages.zip`, zipBlob);
    }catch(e){ console.error(e); alert('PDF→Images failed: '+e.message); }
  });

  // ===== Reorder / Rotate / Delete (spec string) =====
  document.getElementById('btnExportOrder').addEventListener('click', async ()=>{
    const f=document.getElementById('reorderFile').files[0]; if(!f) return alert('Choose a PDF');
    const spec=(document.getElementById('orderSpec').value||'').trim();
    try{
      const {PDFDocument,degrees}=PDFLib; const src=await PDFDocument.load(await readBuf(f));
      const pages=src.getPageIndices(); // 0-based
      // build desired list
      const items = spec? spec.split(',').map(s=>s.trim()).filter(Boolean) : pages.map(i=>(i+1).toString());
      const out=await PDFDocument.create(); const keepIdx=[]; const rotations={};
      for(const token of items){
        const m = token.match(/^(\d+)([RLX])?$/i);
        if(!m) continue;
        const page1 = parseInt(m[1]); const flag=(m[2]||'').toUpperCase();
        if(flag==='X') continue;
        const idx = page1-1; if(idx<0 || idx>=pages.length) continue;
        keepIdx.push(idx);
        if(flag==='R') rotations[idx] = ((rotations[idx]||0)+90)%360;
        if(flag==='L') rotations[idx] = ((rotations[idx]||0)-90)%360;
      }
      if(!keepIdx.length) return alert('No valid pages in order spec.');
      const copied = await out.copyPages(src, keepIdx);
      copied.forEach((p, i)=>{ const rot = rotations[ keepIdx[i] ] || 0; if(rot){ p.setRotation(degrees(rot)); } out.addPage(p); });
      const bytes=await out.save(); downloadBytes('reordered.pdf', bytes);
    }catch(e){ console.error(e); alert('Export failed: '+e.message); }
  });

  // ===== Watermark =====
  document.getElementById('btnWatermark').addEventListener('click', async ()=>{
    const f=document.getElementById('wmFile').files[0]; if(!f) return alert('Choose a PDF');
    const text=document.getElementById('wmText').value || 'WATERMARK';
    const opacity=Math.max(.05, Math.min(1, parseFloat(document.getElementById('wmOpacity').value)||.25));
    const angle=parseFloat(document.getElementById('wmAngle').value)||-30;
    try{
      const {PDFDocument,StandardFonts,rgb,degrees}=PDFLib;
      const pdf=await PDFDocument.load(await readBuf(f));
      const font=await pdf.embedFont(StandardFonts.HelveticaBold);
      pdf.getPages().forEach(page=>{
        const {width,height}=page.getSize();
        const size=Math.max(32, Math.min(width,height)/6);
        page.drawText(text,{x:width/6,y:height/2,size,font,color:rgb(1,1,1),opacity,rotate:degrees(angle)});
      });
      const bytes=await pdf.save(); downloadBytes(`${byName(f)}-watermarked.pdf`, bytes);
    }catch(e){ console.error(e); alert('Watermark failed: '+e.message); }
  });
  </script>
</body>
</html>
